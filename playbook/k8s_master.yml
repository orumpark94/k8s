- name: Kubernetes Master Node Setup
  hosts: master
  become: true
  tasks:
    - name: íŒ¨í‚¤ì§€ ì—…ë°ì´íŠ¸
      yum:
        name: "*"
        state: latest
        update_cache: yes

    - name: í•„ìš”í•œ íŒ¨í‚¤ì§€ ì„¤ì¹˜
      yum:
        name:
          - yum-utils
          - device-mapper-persistent-data
          - lvm2
        state: present

    - name: containerd ì„¤ì¹˜
      yum:
        name: containerd.io
        state: present

    - name: containerd ì„œë¹„ìŠ¤ í™œì„±í™” ë° ì‹œì‘
      systemd:
        name: containerd
        state: started
        enabled: true

    - name: Kubernetes GPG í‚¤ ë“±ë¡ (ìµœì‹  ê³µì‹ ê²½ë¡œ)
      rpm_key:
        state: present
        key: https://pkgs.k8s.io/core:/stable:/v1.28/rpm/repodata/repomd.xml.key

    - name: Kubernetes ì €ì¥ì†Œ ì¶”ê°€
      yum_repository:
        name: kubernetes
        description: Kubernetes Repository
        baseurl: https://pkgs.k8s.io/core:/stable:/v1.28/rpm/
        enabled: yes
        gpgcheck: yes
        repo_gpgcheck: yes
        gpgkey: https://pkgs.k8s.io/core:/stable:/v1.28/rpm/repodata/repomd.xml.key

    - name: Kubernetes íŒ¨í‚¤ì§€ ì„¤ì¹˜ (kubeadm, kubelet, kubectl)
      yum:
        name:
          - kubeadm
          - kubelet
          - kubectl
        state: present

    # ğŸ”¹ Kubelet ì„œë¹„ìŠ¤ í™œì„±í™” ë° ì‹œì‘ ì¶”ê°€
    - name: Kubelet ì„œë¹„ìŠ¤ í™œì„±í™” ë° ì‹¤í–‰
      systemd:
        name: kubelet
        state: started
        enabled: true

    # ğŸ”¹ containerd ë° kubelet ì„œë¹„ìŠ¤ ì¬ì‹œì‘ (ì˜ì¡´ì„± ê´€ë ¨ ë¬¸ì œ ë°©ì§€)
    - name: containerd ë° kubelet ì„œë¹„ìŠ¤ ì¬ì‹œì‘
      systemd:
        name: "{{ item }}"
        state: restarted
      with_items:
        - containerd
        - kubelet

    # ë°©í™”ë²½ ì„¤ì • ì¶”ê°€
    - name: Kubernetes Master ë°©í™”ë²½ ê·œì¹™ ì¶”ê°€
      firewalld:
        port: "{{ item }}"
        permanent: true
        state: enabled
        immediate: yes
      with_items:
        - 6443/tcp
        - 2379-2380/tcp
        - 10251/tcp
        - 10252/tcp

    - name: ë°©í™”ë²½ ì¬ì‹œì‘
      service:
        name: firewalld
        state: restarted
