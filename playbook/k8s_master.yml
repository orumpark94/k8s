- name: Update Kubernetes Repository
  hosts: master
  become: true
  tasks:
    - name: Remove old Kubernetes repository
      file:
        path: /etc/yum.repos.d/kubernetes.repo
        state: absent

    - name: Add new Kubernetes repository
      copy:
        dest: /etc/yum.repos.d/kubernetes.repo
        content: |
          [kubernetes]
          name=Kubernetes Repository
          baseurl=https://pkgs.k8s.io/core:/stable:/v1.28/rpm/
          enabled=1
          gpgcheck=1
          repo_gpgcheck=1
          gpgkey=https://pkgs.k8s.io/core:/stable:/v1.28/rpm/repodata/repomd.xml.key

    - name: Clean YUM cache
      command: yum clean all
      register: yum_clean_result
      changed_when: "'No such file or directory' not in yum_clean_result.stderr"

    - name: Refresh YUM cache
      command: yum makecache
      register: yum_makecache_result
      changed_when: "'Metadata cache created' in yum_makecache_result.stdout"
