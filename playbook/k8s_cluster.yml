- name: Kubernetes Cluster Setup
  hosts: master:workers
  become: yes
  tasks:

    # ✅ containerd 설정 (Kubernetes 조인 전에 적용)
    - name: Ensure containerd config.toml exists
      ansible.builtin.command: containerd config default > /etc/containerd/config.toml
      args:
        creates: /etc/containerd/config.toml

    - name: Set SystemdCgroup in containerd config
      ansible.builtin.replace:
        path: /etc/containerd/config.toml
        regexp: 'SystemdCgroup = false'
        replace: 'SystemdCgroup = true'

    - name: Restart and enable containerd
      ansible.builtin.systemd:
        name: containerd
        state: restarted
        enabled: yes

    - name: Verify containerd is running
      ansible.builtin.command: systemctl is-active containerd
      register: containerd_status
      failed_when: containerd_status.stdout != 'active'

    # ✅ Kubernetes Join 과정 시작
    - name: Fetch the join command from Master
      command: kubeadm token create --print-join-command
      environment:
        KUBECONFIG: /etc/kubernetes/admin.conf
      register: join_command
      run_once: true
      when: "'master' in group_names"

    - name: Ensure join command is available for Worker Nodes
      set_fact:
        worker_join_command: "{{ join_command.stdout | default('') }}"
      run_once: true
      when: "'master' in group_names"

    - name: Propagate join command to Worker Nodes
      set_fact:
        worker_join_command: "{{ hostvars[groups['master'][0]]['worker_join_command'] }}"
      when: "'workers' in group_names"

    - name: Debug worker_join_command on Worker Nodes
      debug:
        msg: "Worker Node Join Command: {{ worker_join_command if worker_join_command else 'No join command received' }}"
      when: "'workers' in group_names"

    - name: Check if worker node is already joined
      stat:
        path: /etc/kubernetes/kubelet.conf
      register: node_joined
      when: "'workers' in group_names"

    - name: Reset Kubernetes on Worker Nodes if already joined
      command: kubeadm reset -f
      when: 
        - "'workers' in group_names"
        - node_joined.stat.exists

    - name: Remove old CNI network config (Worker Nodes)
      file:
        path: /etc/cni/net.d
        state: absent
      when: 
        - "'workers' in group_names"
        - node_joined.stat.exists

    - name: Restart kubelet (Worker Nodes)
      systemd:
        name: kubelet
        state: restarted
      when: 
        - "'workers' in group_names"
        - node_joined.stat.exists

    - name: Join Worker Nodes to Cluster
      command: "{{ worker_join_command }}"
      when: 
        - "'workers' in group_names"
        - not node_joined.stat.exists
        - worker_join_command is defined
      changed_when: false

